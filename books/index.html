<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YASUULABシェア図書館 -蔵書検索-</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="../home/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>

<body>
    <!-- Header Section -->
    <header>
        <h1>YASUULABシェア図書館</h1>
        <nav>
            <ul>
                <li><a href="../index.html">ホーム</a></li>
                <li><a href="../zousyo/index.html">蔵書一覧</a></li>
                <li><a href="../add_books/index.html">本を登録</a></li>
                <li><a href="index.html">本を検索</a></li>
                <li><a href="../karikashi/index.html">貸出・返却</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content Section -->
    <main>
        <!-- 検索フォーム -->
        <section id="search-book">
            <h2>本を検索する</h2>
            <form id="search-form">
                <label for="search-query">検索キーワード:</label>
                <input type="text" id="search-query" name="search-query" placeholder="タイトル、著者、ジャンルで検索">
                <button type="submit">検索</button>
                <label for="search-genre">ジャンル:</label>
                <select id="search-genre" name="search-genre">
                    <option value="0">全て</option>
                    <option value="1">00 総記</option>
                    <option value="2">01 百科事典</option>
                    <option value="3">02 年鑑・雑誌</option>
                    <option value="4">04 情報科学</option>
                    <option value="5">10 哲学</option>
                    <option value="6">11 心理学</option>
                    <option value="7">12 倫理学</option>
                    <option value="8">14 宗教</option>
                    <option value="9">15 仏教</option>
                    <option value="10">16 キリスト教</option>
                    <option value="11">20 歴史総記</option>
                    <option value="12">21 日本歴史</option>
                    <option value="13">22 外国歴史</option>
                    <option value="14">23 伝記</option>
                    <option value="15">25 地理</option>
                    <option value="16">26 旅行</option>
                    <option value="17">30 社会科学総記</option>
                    <option value="18">31 政治</option>
                    <option value="19">32 法律</option>
                    <option value="20">33 経済・財政・統計</option>
                    <option value="21">34 経営</option>
                    <option value="22">36 社会</option>
                    <option value="23">37 教育</option>
                    <option value="24">39 民族・風習</option>
                    <option value="25">40 自然科学総記</option>
                    <option value="26">41 数学</option>
                    <option value="27">42 物理学</option>
                    <option value="28">43 化学</option>
                    <option value="29">44 天文・地学</option>
                    <option value="30">45 生物学</option>
                    <option value="31">47 医学・歯学・薬学</option>
                    <option value="32">50 工学・工学総記</option>
                    <option value="33">51 土木</option>
                    <option value="34">52 建築</option>
                    <option value="35">53 機械</option>
                    <option value="36">54 電気</option>
                    <option value="37">55 電子通信</option>
                    <option value="38">56 海事</option>
                    <option value="39">57 採鉱・治金</option>
                    <option value="40">58 その他の工学</option>
                    <option value="41">60 産業総記</option>
                    <option value="42">61 農林業</option>
                    <option value="43">62 水産業</option>
                    <option value="44">63 商業</option>
                    <option value="45">65 交通・通信</option>
                    <option value="46">70 芸術総記</option>
                    <option value="47">71 絵画・彫刻</option>
                    <option value="48">72 写真・工芸</option>
                    <option value="49">73 音楽・舞踊</option>
                    <option value="50">74 演劇・映画</option>
                    <option value="51">75 体育・スポーツ</option>
                    <option value="52">76 諸芸・娯楽</option>
                    <option value="53">77 家事</option>
                    <option value="54">79 コミック・劇画</option>
                    <option value="55">80 語学総記</option>
                    <option value="56">81 日本語</option>
                    <option value="57">82 英米語</option>
                    <option value="58">84 ドイツ語</option>
                    <option value="59">85 フランス語</option>
                    <option value="60">87 各国語</option>
                    <option value="61">90 文学総記</option>
                    <option value="62">91 日本文学総記</option>
                    <option value="63">92 日本文学詩歌</option>
                    <option value="64">93 日本文学、小説・物語</option>
                    <option value="65">95 日本文学、評論、随筆、その他</option>
                    <option value="66">97 海外文学小説</option>
                    <option value="67">98 海外文学、その他</option>
                </select>

            </form>
        </section>

        <!-- 検索結果の表示エリア -->
        <section id="search-results">
            <h2>検索結果</h2>
            <p id="search-message"></p> <!-- 検索結果メッセージ -->
            <table id="book-table" border="1">
                <thead>
                    <tr>
                        <th>画像</th>
                        <th>タイトル</th>
                        <th>著者</th>
                        <th>ジャンル</th> <!-- ジャンル列を追加 -->
                        <th>在庫状況</th>
                    </tr>
                </thead>
                <tbody id="book-table-body">
                    <!-- 本のデータがここに追加されます -->
                </tbody>
            </table>

        </section>
    </main>

    <footer>
        <p>YASUULABシェア図書館 © 2024</p>
        <p>お問い合わせ: <a href="mailto:
            yasuulab@itnav.co.jp">
                yasuulab@itnav.co.jp</a></p>
    </footer>

    <script src="../utils/firebase.js"></script>
    <script src="../utils/genre.js"></script>
    <script>
        const db = firebase.firestore();

        const genreMap = {
            "1": "00 総記",
            "2": "01 百科事典",
            "3": "02 年鑑・雑誌",
            "4": "04 情報科学",
            "5": "10 哲学",
            "6": "11 心理学",
            "7": "12 倫理学",
            "8": "14 宗教",
            "9": "15 仏教",
            "10": "16 キリスト教",
            "11": "20 歴史総記",
            "12": "21 日本歴史",
            "13": "22 外国歴史",
            "14": "23 伝記",
            "15": "25 地理",
            "16": "26 旅行",
            "17": "30 社会科学総記",
            "18": "31 政治",
            "19": "32 法律",
            "20": "33 経済・財政・統計",
            "21": "34 経営",
            "22": "36 社会",
            "23": "37 教育",
            "24": "39 民族・風習",
            "25": "40 自然科学総記",
            "26": "41 数学",
            "27": "42 物理学",
            "28": "43 化学",
            "29": "44 天文・地学",
            "30": "45 生物学",
            "31": "47 医学・歯学・薬学",
            "32": "50 工学・工学総記",
            "33": "51 土木",
            "34": "52 建築",
            "35": "53 機械",
            "36": "54 電気",
            "37": "55 電子通信",
            "38": "56 海事",
            "39": "57 採鉱・治金",
            "40": "58 その他の工学",
            "41": "60 産業総記",
            "42": "61 農林業",
            "43": "62 水産業",
            "44": "63 商業",
            "45": "65 交通・通信",
            "46": "70 芸術総記",
            "47": "71 絵画・彫刻",
            "48": "72 写真・工芸",
            "49": "73 音楽・舞踊",
            "50": "74 演劇・映画",
            "51": "75 体育・スポーツ",
            "52": "76 諸芸・娯楽",
            "53": "77 家事",
            "54": "79 コミック・劇画",
            "55": "80 語学総記",
            "56": "81 日本語",
            "57": "82 英米語",
            "58": "84 ドイツ語",
            "59": "85 フランス語",
            "60": "87 各国語",
            "61": "90 文学総記",
            "62": "91 日本文学総記",
            "63": "92 日本文学詩歌",
            "64": "93 日本文学、小説・物語",
            "65": "95 日本文学、評論、随筆、その他",
            "66": "97 海外文学小説",
            "67": "98 海外文学、その他"
        };

        // 検索フォームのイベント処理
        document.getElementById("search-form").addEventListener("submit", function (event) {
            event.preventDefault();
            const query = document.getElementById("search-query").value.trim().toLowerCase();
            searchBooks(query);
        });

        // 本を検索して結果を表示する関数
        async function searchBooks(query) {
            query = query.split(" "); // 検索キーワードをスペースで分割
            const matchBooks = [];
            let resultsNum = 0;

            const tbody = document.getElementById('book-table-body');
            tbody.innerHTML = ""; // 結果のリストをクリア

            try {
                const snapshot = await db.collection('books').get(); // Firestoreから全データ取得
                snapshot.forEach(doc => {
                    const data = doc.data();

                    // キーワードをタイトル、著者、ジャンルのいずれかにマッチさせる
                    const matchesQuery = query.some(keyword =>
                        data.title.toLowerCase().includes(keyword) || // タイトルに含まれるか
                        data.author.toLowerCase().includes(keyword) || // 著者に含まれるか
                        (data.genre && data.genre.toLowerCase().includes(keyword)) // ジャンルに含まれるか
                    );

                    if (matchesQuery) {
                        matchBooks.push(doc);
                    }
                });

                matchBooks.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');

                    // 画像セル
                    const imgCell = document.createElement('td');
                    const imgViewer = document.createElement("img");
                    imgViewer.src = `https://ndlsearch.ndl.go.jp/thumbnail/${data.isbn}.jpg`;
                    imgCell.appendChild(imgViewer);
                    row.appendChild(imgCell);

                    // タイトルセル
                    const titleCell = document.createElement('td');
                    titleCell.textContent = data.title;
                    row.appendChild(titleCell);

                    // 著者セル
                    const authorCell = document.createElement('td');
                    authorCell.textContent = data.author;
                    row.appendChild(authorCell);

                    // ジャンルセル (追加部分)
                    const genreCell = document.createElement('td');
                    const genreName = genreMap[data.genre] || "未設定"; // 対応表から取得。該当がない場合は「未設定」
                    genreCell.textContent = genreName;
                    row.appendChild(genreCell);


                    // 在庫状況セル
                    const stockCell = document.createElement('td');
                    stockCell.textContent = data.isStock ? "在庫あり" : "貸出中";
                    row.appendChild(stockCell);

                    // 行をテーブルに追加
                    tbody.appendChild(row);
                    resultsNum++;
                });

                // 結果メッセージの更新
                if (resultsNum > 0) {
                    document.getElementById("search-message").textContent = `${resultsNum}件の結果が見つかりました`;
                } else {
                    document.getElementById("search-message").textContent = "該当する本が見つかりませんでした";
                }
            } catch (error) {
                console.error("Error fetching books:", error);
                document.getElementById("search-message").textContent = "検索中にエラーが発生しました。";
            }
        }


    </script>
</body>

</html>